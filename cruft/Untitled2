type StepFunction<State> = (response: any | undefined, data: State, actions: Actions<State>) => Promise<any | undefined>

interface Actions<State> {
  say(message: string | string[]): {
    next: (fn: StepFunction<State>) => Promise<void>,
    finish: () => Promise<void>
  }
  promptText(question: string): {
    next: (fn: StepFunction<State>) => Promise<string>,
    finish: () => Promise<void>
  }
  next(fn: StepFunction<State>): void
}

interface Conversation<State>  {
  [key: string]: StepFunction<State>
}

interface TestConversationState {
  username?: string
  age?: number
}

const TestConversation: Conversation<TestConversationState> = {
  welcomeStep(response, state, actions) {
    return actions.say([
      "Hi, I am your cool bot buddy.",
      "Let's get started!"
    ]).next(this.usernameStep)
  },

  promptUsernameStep(response, state, actions) {
    actions.next()
    return actions.promptText("What is your name?").next(this.greetingStep)
  },

  greetingStep(response, state, actions) {
    state.username = response
    return actions.say(`Nice to meet you ${state.username}.`).next(this.promptAgeStep)
  },

  promptAgeStep(response, state, actions) {
    return actions.promptText("What is your age?").next(this.handleAgeResponseStep)
  },

  handleAgeResponseStep(response, state, actions) {
    const age = parseInt(response, 10)
    if(isNaN(age)) {
      return actions.promptText(`Hm, I don't understand that. Please enter your age a number.`).next(this.handleAgeResponseStep)
    } else {
      state.age = age
      return actions.say(`Well, it seems your name is ${state.username}, and your age is ${state.age}`).finish()
    }
  }
}

// export default TestConversation

async function runConversationStep<State>(step: StepFunction<State>, response: any | undefined, state: State) {
  let nextStep: StepFunction<State> | undefined

  const next = (fn: StepFunction<State>) => {
    nextStep = fn
    // runConversationStep(fn, state)
  }

  const finish = () => nextStep = undefined


  const actions: Actions<State> = {
    async say(message: string | string[]) {
      console.log("M >", "message")
      return { next, finish }
    }
    async promptText(question: string) {
      console.log("Q >", "message")
      return { next, finish }
    }
  }

  const stepResult = await step(response, state, actions)
  if(nextStep) {
    runConversationStep(nextStep, {}, state)
  }
}
